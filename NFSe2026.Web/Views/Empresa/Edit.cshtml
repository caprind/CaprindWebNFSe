@model NFSe2026.Web.Models.EmpresaEditViewModel
@{
    ViewData["Title"] = "Editar Dados da Empresa";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0">
                <span style="font-size: 1.5em;">üè¢</span> Editar Dados da Empresa
            </h2>
            <hr />
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="empresaForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="CNPJ" />
                        <input type="hidden" asp-for="RazaoSocial" />

                        <!-- Informa√ß√µes B√°sicas -->
                        <h5 class="mb-3 text-primary">Informa√ß√µes B√°sicas</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="CNPJ" class="form-label"></label>
                                <input asp-for="CNPJ" class="form-control" readonly />
                                <small class="form-text text-muted">CNPJ n√£o pode ser alterado</small>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="RazaoSocial" class="form-label"></label>
                                <input asp-for="RazaoSocial" class="form-control" readonly />
                                <small class="form-text text-muted">Raz√£o Social n√£o pode ser alterada</small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label asp-for="NomeFantasia" class="form-label"></label>
                                <input asp-for="NomeFantasia" class="form-control" />
                                <span asp-validation-for="NomeFantasia" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="InscricaoEstadual" class="form-label"></label>
                                <input asp-for="InscricaoEstadual" class="form-control" />
                                <span asp-validation-for="InscricaoEstadual" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="InscricaoMunicipal" class="form-label"></label>
                                <input asp-for="InscricaoMunicipal" class="form-control" />
                                <span asp-validation-for="InscricaoMunicipal" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Logotipo -->
                        <h5 class="mb-3 mt-4 text-primary">Logotipo</h5>
                        <div class="mb-3">
                            @if (!string.IsNullOrEmpty(Model.LogotipoAtual))
                            {
                                <div class="mb-2">
                                    <label class="form-label">Logotipo Atual</label>
                                    <div>
                                        <img src="data:image/png;base64,@Model.LogotipoAtual" alt="Logotipo" 
                                             style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; padding: 5px; border-radius: 5px;" />
                                    </div>
                                </div>
                            }
                            <label for="logotipoFile" class="form-label">Alterar Logotipo</label>
                            <input type="file" id="logotipoFile" name="logotipoFile" accept="image/*" class="form-control" />
                            <small class="form-text text-muted">Formatos aceitos: JPG, PNG, GIF. Tamanho m√°ximo recomendado: 500KB</small>
                            <input type="hidden" asp-for="Logotipo" id="logotipoBase64" />
                            <input type="hidden" asp-for="LogotipoAtual" />
                        </div>

                        <!-- Endere√ßo -->
                        <h5 class="mb-3 mt-4 text-primary">Endere√ßo</h5>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label asp-for="Endereco" class="form-label"></label>
                                <input asp-for="Endereco" class="form-control" />
                                <span asp-validation-for="Endereco" class="text-danger"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="Numero" class="form-label"></label>
                                <input asp-for="Numero" class="form-control" />
                                <span asp-validation-for="Numero" class="text-danger"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="CEP" class="form-label"></label>
                                <input asp-for="CEP" class="form-control" maxlength="8" />
                                <span asp-validation-for="CEP" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Complemento" class="form-label"></label>
                                <input asp-for="Complemento" class="form-control" />
                                <span asp-validation-for="Complemento" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Bairro" class="form-label"></label>
                                <input asp-for="Bairro" class="form-control" />
                                <span asp-validation-for="Bairro" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Cidade" class="form-label"></label>
                                <input asp-for="Cidade" class="form-control" />
                                <span asp-validation-for="Cidade" class="text-danger"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="UF" class="form-label"></label>
                                <input asp-for="UF" class="form-control" maxlength="2" />
                                <span asp-validation-for="UF" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="CodigoMunicipio" class="form-label"></label>
                                <input asp-for="CodigoMunicipio" class="form-control" maxlength="7" placeholder="C√≥digo IBGE" />
                                <span asp-validation-for="CodigoMunicipio" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Contato -->
                        <h5 class="mb-3 mt-4 text-primary">Contato</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Email" class="form-label"></label>
                                <input asp-for="Email" class="form-control" type="email" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Telefone" class="form-label"></label>
                                <input asp-for="Telefone" class="form-control" />
                                <span asp-validation-for="Telefone" class="text-danger"></span>
                            </div>
                        </div>

                        <hr class="my-4" />
                        
                        <!-- Se√ß√£o de Certificado Digital -->
                        <h5 class="mb-3 text-primary">Certificado Digital</h5>
                        
                        @if (Model.TemCertificadoDigital && Model.DataVencimentoCertificado.HasValue)
                        {
                            var diasRestantes = (Model.DataVencimentoCertificado.Value - DateTime.Now).Days;
                            var classeAlerta = diasRestantes <= 30 ? "alert-danger" : diasRestantes <= 90 ? "alert-warning" : "alert-success";
                            
                            <div class="alert @classeAlerta mb-3">
                                <strong>üìÖ Certificado Digital Cadastrado:</strong>
                                <ul class="mb-0">
                                    <li><strong>Data de Vencimento:</strong> @Model.DataVencimentoCertificado.Value.ToString("dd/MM/yyyy")</li>
                                    <li><strong>Dias Restantes:</strong> @diasRestantes dia(s)</li>
                                    @if (diasRestantes <= 30)
                                    {
                                        <li class="text-danger"><strong>‚ö†Ô∏è ATEN√á√ÉO: Certificado pr√≥ximo do vencimento! Renove o quanto antes.</strong></li>
                                    }
                                    else if (diasRestantes <= 90)
                                    {
                                        <li class="text-warning"><strong>‚ö†Ô∏è Certificado vencendo em breve. Considere renovar.</strong></li>
                                    }
                                </ul>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-3">
                                <strong>‚ö†Ô∏è Certificado Digital n√£o cadastrado:</strong>
                                <p class="mb-0">√â necess√°rio cadastrar um certificado digital para assinar e emitir notas fiscais eletr√¥nicas.</p>
                            </div>
                        }
                        
                        <div class="alert alert-info mb-3">
                            <strong>‚ÑπÔ∏è Sobre o Certificado Digital:</strong>
                            <ul class="mb-0">
                                <li>O certificado digital √© necess√°rio para assinar e emitir notas fiscais eletr√¥nicas</li>
                                <li>Certifique-se de cadastrar um certificado v√°lido e n√£o expirado</li>
                                <li>A data de vencimento √© extra√≠da automaticamente do certificado</li>
                            </ul>
                        </div>
                        
                        <!-- Provedor de NFSe -->
                        <h5 class="mb-3 mt-4 text-primary">üì° Provedor de NFSe (Emitente)</h5>
                        <div class="mb-3">
                            <label asp-for="ProvedorNFSe" class="form-label fw-bold">Selecione o Provedor de NFSe</label>
                            <select asp-for="ProvedorNFSe" class="form-select form-select-lg" id="provedorNFSeSelect">
                                <option value="1">üèõÔ∏è API Nacional NFSe (Receita Federal)</option>
                                <option value="2">üî∑ NS Tecnologia</option>
                            </select>
                            <span asp-validation-for="ProvedorNFSe" class="text-danger"></span>
                            
                            <!-- Informa√ß√µes sobre cada provedor -->
                            <div id="infoProvedor" class="mt-3">
                                <div id="infoNacional" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">üèõÔ∏è API Nacional NFSe (Receita Federal)</h6>
                                        <ul class="mb-0 small">
                                            <li>Provedor oficial da Receita Federal do Brasil</li>
                                            <li>Requer certificado digital A1 ou A3</li>
                                            <li>Requer ClientId e ClientSecret configurados</li>
                                            <li>Ambiente: Homologa√ß√£o ou Produ√ß√£o</li>
                                        </ul>
                                    </div>
                                </div>
                                <div id="infoNSTecnologia" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">üî∑ NS Tecnologia</h6>
                                        <ul class="mb-0 small">
                                            <li>Provedor terceirizado de emiss√£o de NFSe</li>
                                            <li>Requer Token de autentica√ß√£o configurado</li>
                                            <li>Ambiente: Homologa√ß√£o ou Produ√ß√£o</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <small class="form-text text-muted d-block mt-2">
                                <strong>‚ö†Ô∏è Importante:</strong> O provedor selecionado ser√° utilizado para todas as emiss√µes de notas fiscais desta empresa. 
                                Certifique-se de que as credenciais e certificados necess√°rios est√£o configurados corretamente.
                            </small>
                        </div>

                        <div class="d-flex gap-2 mb-4">
                            <a asp-action="CertificadoDigital" class="btn btn-info">
                                <span>üîê</span> @(Model.TemCertificadoDigital ? "Gerenciar" : "Cadastrar") Certificado Digital
                            </a>
                            <a asp-action="CredenciaisAPI" class="btn btn-warning">
                                <span>üîë</span> @(Model.TemClientIdSecret ? "Gerenciar" : "Cadastrar") Credenciais da API
                            </a>
                        </div>

                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary">
                                <span>üíæ</span> Salvar Altera√ß√µes
                            </button>
                            <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.getElementById('logotipoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Valida tamanho (500KB = 500 * 1024 bytes)
                if (file.size > 500 * 1024) {
                    alert('O arquivo √© muito grande. Por favor, escolha uma imagem menor que 500KB.');
                    e.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onloadend = function() {
                    const base64String = reader.result.split(',')[1]; // Remove o prefixo "data:image/...;base64,"
                    document.getElementById('logotipoBase64').value = base64String;
                };
                reader.readAsDataURL(file);
            }
        });

        // Mostra informa√ß√µes do provedor selecionado
        function atualizarInfoProvedor() {
            const select = document.getElementById('provedorNFSeSelect');
            const infoNacional = document.getElementById('infoNacional');
            const infoNSTecnologia = document.getElementById('infoNSTecnologia');
            
            if (select.value === '1') {
                infoNacional.style.display = 'block';
                infoNSTecnologia.style.display = 'none';
            } else if (select.value === '2') {
                infoNacional.style.display = 'none';
                infoNSTecnologia.style.display = 'block';
            } else {
                infoNacional.style.display = 'none';
                infoNSTecnologia.style.display = 'none';
            }
        }

        // Inicializa a informa√ß√£o do provedor ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            atualizarInfoProvedor();
            document.getElementById('provedorNFSeSelect').addEventListener('change', atualizarInfoProvedor);
        });
    </script>
}

